#! /bin/bash

#
# This script submits all jobs to a queue if there's a limit.
# The default limit is 10, but can be overwritten by
# the environment variable
#	SWEET_JOB_SCHEDULER_NUM_JOB_LIMITATION
#


LIMIT=10
if [[ ! -z "$SWEET_JOB_SCHEDULER_NUM_JOB_LIMITATION" ]]; then
	LIMIT=$SWEET_JOB_SCHEDULER_NUM_JOB_LIMITATION
fi

echo_info "Using job limitation of ${SWEET_JOB_SCHEDULER_NUM_JOB_LIMITATION}"


JOBS=""
if [[ ! -z "$1" ]]; then
	JOBS="$@"
fi

for JOB in $JOBS; do
	while true; do
		NUM_JOBS=$($SWEET_PLATFORM_DIR/platform_jobs_status | wc -l)
		if [[ $NUM_JOBS -lt $LIMIT ]]; then
			break
		fi
		echo_info "Found $NUM_JOBS in queue, waiting to submit more jobs"
		sleep 1
	done

	echo_info "Submitting job '${JOB}'"
	$SWEET_PLATFORM_DIR/platform_jobs_submit $JOB
done
