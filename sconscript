import os
import sys
import glob

Import('env')
env.Append(CPPPATH = ['include'])


sweet_root = env['SWEET_ROOT']+'/'


mainsrcadddir = ''

if env['compile_program'] != '':
	mainsrcadddir = 'src/programs/'+env['compile_program']
elif env['unit_test'] != '':
	mainsrcadddir = 'src/unit_tests/'+env['unit_test']
else:
	mainsrcadddir = ''

if mainsrcadddir != '':


	#
	# Add main source file
	#
	env.src_files.append(env.Object(mainsrcadddir+'.cpp'))


	real_foodir = sweet_root+mainsrcadddir

	#
	# Check for program specific source code files in
	#    src/programs/[compile_program]
	#
	if os.path.isdir(real_foodir):

		cpp_files = glob.glob(real_foodir+'/*.cpp')
		for i in cpp_files:
			filerelpath = i.replace(sweet_root, '')

			# SWE PLANE REXI SPECIAL HANDLING
			if os.path.basename(filerelpath) in ['SWE_Plane_REXI.cpp', 'SWE_Sphere_REXI.cpp']:
				if env['rexi_thread_parallel_sum']=='enable':
					env_omp = env.Clone()
					env_omp.Append(CXXFLAGS = ' -fopenmp')
					env_omp.src_files.append(env_omp.Object(filerelpath))
				else:
					env.src_files.append(env.Object(filerelpath))
			else:
				env.src_files.append(env.Object(filerelpath))

		fortran_files = glob.glob(real_foodir+'/*.f90')
		for i in fortran_files:
			filerelpath = i.replace(sweet_root, '')

			env.src_files.append(env.Object(filerelpath))


	Export('env')

